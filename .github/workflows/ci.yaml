name: CI

on:
    push:
        branches: ['main']
    pull_request:
        types: [opened, synchronize]

env:
    TURBO_TELEMETRY_DISABLED: 1

permissions:
    contents: read
    id-token: write

jobs:
    lint:
        runs-on: ubuntu-latest

        steps:
            - uses: actions/checkout@v5

            - name: Pre-install yarn
              run: npm install -g yarn

            - name: Use Node.js 22.x
              uses: actions/setup-node@v5
              with:
                  node-version: 22.x
                  cache: 'yarn'

            - name: Install dependencies
              run: yarn

            - name: Lint
              run: yarn lint

    test:
        name: Test
        timeout-minutes: 15
        runs-on: ubuntu-latest
        if: github.event_name != 'push' || github.ref != 'refs/heads/main'
        steps:
            - name: Checkout source
              uses: actions/checkout@v5

            - name: Pre-install yarn
              run: npm install -g yarn

            - name: Use Node.js 22.x
              uses: actions/setup-node@v5
              with:
                  node-version: 22.x
                  cache: 'yarn'

            - name: Install
              run: yarn

            - name: Test
              run: yarn test

    release:
        name: Build and publish
        timeout-minutes: 15
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        runs-on: ubuntu-latest
        steps:
            - name: Checkout source
              uses: actions/checkout@v5
              with:
                  fetch-depth: 2

            - name: Pre-install yarn
              run: npm install -g yarn

            - name: Use Node.js 22.x
              uses: actions/setup-node@v5
              with:
                  node-version: 22.x
                  cache: 'yarn'
                  registry-url: https://registry.npmjs.org

            - name: Install
              run: yarn

            - name: Build production bundle
              run: yarn build

            - name: Test
              run: yarn test

            - run: npm install -g npm@latest

            - name: Publish @jobindex/pdf-viewer
              working-directory: packages/pdf-viewer
              run: npm publish --access public
